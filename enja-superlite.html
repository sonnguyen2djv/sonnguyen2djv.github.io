<!DOCTYPE html>
<html>
<head>
  <title>My 2 Vue app</title>

  <script src="https://unpkg.com/vue"></script>
  <!--
  <script src="vue.js"></script>
  -->

  <script>
/**--------------- Global variables declarations ---------------*/
window.GLOB = {
  /**@type TypeEnJa[]*/
  ENJA: null,
  INDEX_CURRENT: 0,
  // Configs:
  AUDIO_PLAYBACK_RATE: 0.9,
  /**Number of time that Japanese audio will be played before playing English audio.*/
  REPLAY_JA_BEFORE: 2,
  /**Number of time that Japanese audio will be played after playing English audio.*/
  REPLAY_JA_AFTER: 1,
  /**Number of time that English audio will be played.*/
  REPLAY_EN: 1,
};
  </script>

  <script>
/**Initializations*/
window.addEventListener('keydown', function(e) {
  if(e.keyCode === 32 && e.target === document.body) {
    e.preventDefault();
    document.querySelector('audio').play();
  }
});
window.onload = async () => {
  await fetchEnJaJson();
  const hash = window.location.hash ? window.location.hash.substring(1) : null;
  const parsedFloat = hash ? parseFloat(hash) : null;
  const start = (parsedFloat == null || isNaN(parsedFloat)) ? 0 : parsedFloat;
  GLOB.INDEX_CURRENT = start;
  while (true) {
    try {
      const enJaItem = GLOB.ENJA[GLOB.INDEX_CURRENT];
      for (let i = 0; i < GLOB.REPLAY_JA_BEFORE; i++) {
        if (i) {
          await sleep(500);
        }
        await playAudioElmFromUrl(enJaItem.japaneseAudioFileName);
        await waitForAudioFinish();
      }
      await sleep(500);
      for (let i = 0; i < GLOB.REPLAY_EN; i++) {
        if (i) {
          await sleep(500);
        }
        await playAudioElmFromUrl(enJaItem.englishAudioFileName);
        await waitForAudioFinish();
      }
      await sleep(500);
      for (let i = 0; i < GLOB.REPLAY_JA_AFTER; i++) {
        if (i) {
          await sleep(500);
        }
        await playAudioElmFromUrl(enJaItem.japaneseAudioFileName);
        await waitForAudioFinish();
      }
      GLOB.INDEX_CURRENT++;
      if (GLOB.INDEX_CURRENT > GLOB.ENJA.length - 1) {
        GLOB.INDEX_CURRENT = 0;
      }
    } catch (e) {
      console.debug(e);
    }
  }
};
  </script>

  <script>
async function fetchEnJaJson() {
  try {
    const res = await fetch('/enjasentences.json');
    const jsonObj = await res.json();
    console.log(jsonObj);
    GLOB.ENJA = jsonObj;
  } catch (e) {
    console.error(e);
  }
}
/**
 * @param {HTMLAudioElement} audioElm
 * @param {string} audioUrl
 * */
function playAudioElmFromUrl(audioUrl) {
  const audioElm = document.querySelector('audio');
  audioElm.src = audioUrl;
  audioElm.playbackRate = GLOB.AUDIO_PLAYBACK_RATE;
  return audioElm.play();
}
  </script>

  <script>
function sleep(timeMs) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      resolve('foo');
    }, timeMs);
  });
}
async function waitForAudioFinish() {
  try {
    const audio = document.querySelector('audio');
    while (!audio.paused) {
      console.log('waiting for audio to finish...');
      await sleep(500);
    }
    console.log('audio finished!');
  } catch (e) {
    console.error(e);
  }
}
  </script>

</head>
<body>
  <div id="app">
    <div>OK-vue</div>
    <div v-if="glob && glob.ENJA">
      <div>OK-enja</div>
      <div>Index: {{glob.INDEX_CURRENT}} - Lesson: {{glob.ENJA[glob.INDEX_CURRENT].lessonId}}</div>
      <div>
        <div class="d-flex">
          <div class="d-flex text-center-for-flex hover-yellow" style="width: 10px;"></div>
          <div class="flex-grow-1">
            <div v-for="line of glob.ENJA[glob.INDEX_CURRENT].japaneseSentences"
                 class="hover-yellow">{{line.rawText}}</div>
          </div>
        </div>
      </div>
    </div>
    <div>
      <audio id="elmId_audio" src="" controls style="height: 100%; width: 100%;"></audio>
    </div>
  </div>

  <script>
    const app = new Vue({
      el: '#app',
      watch: {
      },
      props: {
        glob: GLOB,
      },
      data: {
      },
      methods: {
      }
    });
  </script>
</body>
</html>
